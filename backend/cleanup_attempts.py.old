"""
Clean up old exam attempts and Redis timers
"""
import os
import django

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')
django.setup()

from core.models import Attempt
from api.redis_utils import timer_manager

print("Cleaning up old exam attempts...")
print("-" * 50)

# Get all ongoing attempts
ongoing_attempts = Attempt.objects.filter(status='ongoing')
print(f"Found {ongoing_attempts.count()} ongoing attempts")

for attempt in ongoing_attempts:
    print(f"\nAttempt ID: {attempt.id}")
    print(f"  User: {attempt.user.username}")
    print(f"  Test: {attempt.test.title}")
    print(f"  Created: {attempt.created_at}")
    
    # Check Redis timer
    remaining = timer_manager.get_remaining_time(attempt.id)
    if remaining == -2:
        print(f"  ‚è∞ Timer expired - marking as timeout")
        attempt.status = 'timeout'
        attempt.save()
    else:
        print(f"  ‚è∞ Timer active: {remaining} seconds remaining")
        print(f"  üóëÔ∏è  Deleting timer...")
        timer_manager.delete_timer(attempt.id)
        attempt.status = 'timeout'
        attempt.save()

print("\n" + "=" * 50)
print("‚úÖ Cleanup complete!")
print("=" * 50)
print("\nYou can now start a fresh exam.")
